//! TypeScript bindings generator for Panager
//!
//! This binary generates TypeScript type definitions from Rust types
//! using specta. Run with: cargo run --bin generate-bindings
//!
//! The generated types are written to ../src/bindings/types.ts

use specta_typescript::{BigIntExportBehavior, Typescript};
use std::path::PathBuf;

// Import all types that need TypeScript bindings
use panager_lib::db::models::{
    // Scope models
    GitIncludeIf, IgnoredFolderWarning, Scope, ScopeGitConfig, ScopeLink, ScopeWithLinks,
    TempProjectSettings,
    // Project models
    GitStatusCache, Project, ProjectWithStatus, ProjectLink, ProjectGroup, ProjectCommand,
    ProjectStatistics, LastCommitInfo, LanguageInfo, ContributorInfo,
    // Editor models
    Editor, SshAlias,
    // DTOs
    CloneOptions, CloneProgress, CloneResult, CreateProjectRequest, CreateScopeLinkRequest,
    CreateProjectLinkRequest, CreateProjectGroupRequest, CreateProjectCommandRequest,
    CreateScopeRequest, CreateSshAliasRequest, TempProjectProgress, TempProjectRequest,
    TempProjectResult, CommandResult,
};
use panager_lib::services::diagnostics::{
    DiagnosticFix, DiagnosticIssue, DisabledRule, RuleGroup, RuleMetadata, ScanState, Severity,
    ScopeDiagnosticsSummary,
};

fn main() {
    // Determine output path - go up from src-tauri to project root, then to src/bindings
    let output_path = PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .expect("Could not find parent directory")
        .join("src")
        .join("bindings")
        .join("types.ts");

    // Ensure the bindings directory exists
    if let Some(parent) = output_path.parent() {
        std::fs::create_dir_all(parent).expect("Failed to create bindings directory");
    }

    println!("Generating TypeScript bindings to: {}", output_path.display());

    // Create TypeScript export config with BigInt support
    let config = Typescript::default().bigint(BigIntExportBehavior::Number);

    // Collect all type definitions
    let mut output = String::new();
    
    // Add header comment
    output.push_str("// This file is auto-generated by generate-bindings\n");
    output.push_str("// Do not edit manually. Run `cargo run --bin generate-bindings` to regenerate.\n");
    output.push_str("// Or use `npm run generate:types` from the project root.\n\n");

    // Add JsonValue type (used by serde_json::Value fields)
    output.push_str("/**\n * JSON value type for dynamic/untyped data\n */\n");
    output.push_str("export type JsonValue = null | boolean | number | string | JsonValue[] | { [key: string]: JsonValue }\n\n");

    // Export each type
    macro_rules! export_type {
        ($($type:ty),*) => {
            $(
                match specta_typescript::export::<$type>(&config) {
                    Ok(ts) => {
                        output.push_str(&ts);
                        output.push_str("\n\n");
                    }
                    Err(e) => eprintln!("Warning: Failed to export {}: {}", stringify!($type), e),
                }
            )*
        };
    }

    export_type!(
        // Scope models
        TempProjectSettings,
        Scope,
        ScopeLink,
        ScopeWithLinks,
        ScopeGitConfig,
        IgnoredFolderWarning,
        GitIncludeIf,
        // Project models
        Project,
        GitStatusCache,
        ProjectWithStatus,
        ProjectLink,
        ProjectGroup,
        ProjectCommand,
        ProjectStatistics,
        LastCommitInfo,
        LanguageInfo,
        ContributorInfo,
        // Editor models
        Editor,
        SshAlias,
        // DTOs
        CreateScopeRequest,
        CreateSshAliasRequest,
        CreateProjectRequest,
        CreateScopeLinkRequest,
        CreateProjectLinkRequest,
        CreateProjectGroupRequest,
        CreateProjectCommandRequest,
        TempProjectRequest,
        CommandResult,
        TempProjectResult,
        TempProjectProgress,
        CloneOptions,
        CloneResult,
        CloneProgress,
        // Diagnostics
        Severity,
        RuleGroup,
        RuleMetadata,
        DiagnosticIssue,
        DiagnosticFix,
        DisabledRule,
        ScanState,
        ScopeDiagnosticsSummary
    );

    // Write to file
    std::fs::write(&output_path, &output).expect("Failed to write bindings file");

    println!("Successfully generated TypeScript bindings!");
    println!("Types exported:");
    println!("  - Scope models: TempProjectSettings, Scope, ScopeLink, ScopeWithLinks, ScopeGitConfig, IgnoredFolderWarning, GitIncludeIf");
    println!("  - Project models: Project, GitStatusCache, ProjectWithStatus");
    println!("  - Editor models: Editor, SshAlias");
    println!("  - DTOs: CreateScopeRequest, CreateSshAliasRequest, CreateProjectRequest, CreateScopeLinkRequest, TempProjectRequest, TempProjectResult, TempProjectProgress, CloneOptions, CloneResult, CloneProgress");
    println!("  - Diagnostics: Severity, RuleGroup, RuleMetadata, DiagnosticIssue, DiagnosticFix, DisabledRule, ScanState, ScopeDiagnosticsSummary");
}
